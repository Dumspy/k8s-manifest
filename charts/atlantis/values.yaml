atlantis:
  image:
    tag: v0.32.0
    pullPolicy: IfNotPresent

  # Repository allowlist
  orgAllowlist: "github.com/Dumspy/infra-tofu"

  # Server configuration
  environment:
    ATLANTIS_PORT: "4141"
    ATLANTIS_DATA_DIR: "/atlantis"
    ATLANTIS_ATLANTIS_URL: "https://atlantis.rger.dev"
    ATLANTIS_GH_APP_KEY_FILE: "/var/secrets/github-app/key.pem"
    ATLANTIS_DEFAULT_TF_DISTRIBUTION: opentofu

  # Server-side repo config - allows repo-level atlantis.yaml to override workflows
  repoConfig: |
    ---
    repos:
    - id: /.*/
      apply_requirements: []
      workflow: default
      allowed_overrides: [workflow, apply_requirements]
      allow_custom_workflows: false
    workflows:
      default:
        plan:
          steps: [init, plan]
        apply:
          steps: [apply]

  # Use OpenTofu instead of Terraform
  defaultTFDistribution: opentofu

  # GitHub App credentials via environmentSecrets
  environmentSecrets:
    - name: ATLANTIS_GH_APP_ID
      secretKeyRef:
        name: atlantis-vcs-credentials
        key: app-id
    - name: ATLANTIS_GH_APP_INSTALLATION_ID
      secretKeyRef:
        name: atlantis-vcs-credentials
        key: installation-id
    - name: ATLANTIS_GH_WEBHOOK_SECRET
      secretKeyRef:
        name: atlantis-vcs-credentials
        key: github_secret

  # Mount GitHub App secret as volume for private key file
  extraVolumes:
    - name: github-app-key
      secret:
        secretName: atlantis-vcs-credentials
        items:
          - key: key.pem
            path: key.pem

  extraVolumeMounts:
    - name: github-app-key
      mountPath: /var/secrets/github-app
      readOnly: true

  # Service configuration - ClusterIP (exposed via cloudflare tunnel)
  service:
    type: ClusterIP
    port: 80

  # Ingress disabled - using cloudflare tunnel instead
  ingress:
    enabled: false

  # Resource requirements per AGENTS.md standards
  resources:
    requests:
      memory: 256Mi
      cpu: 100m
    limits:
      memory: 512Mi
      cpu: 500m

  # Liveness probe - Atlantis needs 30s to start (default 5s is too short)
  livenessProbe:
    initialDelaySeconds: 30

  # OpenTofu provider credentials - loaded from 1Password secret
  loadEnvFromSecrets:
    - opentofu-provider-secrets

  # GitHub App needs --write-git-creds to support cloning
  extraArgs:
    - --write-git-creds
