argocd-image-updater:
  config:
    registries:
      - name: GitHub Container Registry
        api_url: https://ghcr.io
        prefix: ghcr.io
        default: true
  crds:
    install: true
    keep: true

argo-cd:
  server:
    service:
      type: NodePort
  configs:
    params:
      server.insecure: "true"
  notifications:
    enabled: true
    secret:
      create: false # using 1Password operator instead
    cm:
      create: true
    notifiers:
      service.slack: |
        token: $slack-token
        icon: https://argo-cd.readthedocs.io/en/stable/assets/logo.png
        channels: ["deployments"]
    templates:
      template.app-deployed: |
        slack:
          attachments: |
            [{
              "color": "#18be52",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": ":rocket: *{{.app.metadata.name}}* deployed to `{{.app.spec.destination.namespace}}`"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {"type": "mrkdwn", "text": "*Revision:*\n`{{.app.status.sync.revision | substr 0 7}}`"},
                    {"type": "mrkdwn", "text": "*Repo:*\n<{{.app.spec.source.repoURL}}|{{.app.spec.source.repoURL | replace "https://github.com/" "" | replace ".git" ""}}>"}
                  ]
                },
                {
                  "type": "context",
                  "elements": [{"type": "mrkdwn", "text": "<http://argocd.internal.rger.dev/applications/argocd/{{.app.metadata.name}}|View in ArgoCD>"}]
                }
              ]
            }]
      template.app-sync-failed: |
        slack:
          attachments: |
            [{
              "color": "#e53935",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": ":x: *{{.app.metadata.name}}* sync failed"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {"type": "mrkdwn", "text": "*Namespace:*\n`{{.app.spec.destination.namespace}}`"},
                    {"type": "mrkdwn", "text": "*Phase:*\n`{{.app.status.operationState.phase}}`"}
                  ]
                },
                {{if .app.status.operationState.message}}
                {
                  "type": "section",
                  "text": {"type": "mrkdwn", "text": "*Error:*\n```{{.app.status.operationState.message}}```"}
                },
                {{end}}
                {
                  "type": "context",
                  "elements": [{"type": "mrkdwn", "text": "<http://argocd.internal.rger.dev/applications/argocd/{{.app.metadata.name}}|View in ArgoCD>"}]
                }
              ]
            }]
      template.app-health-degraded: |
        slack:
          attachments: |
            [{
              "color": "#ff9800",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": ":warning: *{{.app.metadata.name}}* health degraded"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {"type": "mrkdwn", "text": "*Namespace:*\n`{{.app.spec.destination.namespace}}`"},
                    {"type": "mrkdwn", "text": "*Health:*\n`{{.app.status.health.status}}`"}
                  ]
                },
                {{if .app.status.health.message}}
                {
                  "type": "section",
                  "text": {"type": "mrkdwn", "text": "*Reason:*\n{{.app.status.health.message}}"}
                },
                {{end}}
                {
                  "type": "context",
                  "elements": [{"type": "mrkdwn", "text": "<http://argocd.internal.rger.dev/applications/argocd/{{.app.metadata.name}}|View in ArgoCD>"}]
                }
              ]
            }]
      template.app-sync-succeeded: |
        slack:
          attachments: |
            [{
              "color": "#18be52",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": ":white_check_mark: *{{.app.metadata.name}}* synced successfully"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {"type": "mrkdwn", "text": "*Namespace:*\n`{{.app.spec.destination.namespace}}`"},
                    {"type": "mrkdwn", "text": "*Revision:*\n`{{.app.status.sync.revision | substr 0 7}}`"}
                  ]
                },
                {
                  "type": "context",
                  "elements": [{"type": "mrkdwn", "text": "<http://argocd.internal.rger.dev/applications/argocd/{{.app.metadata.name}}|View in ArgoCD>"}]
                }
              ]
            }]
      template.app-rollback: |
        slack:
          attachments: |
            [{
              "color": "#9c27b0",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": ":rewind: *{{.app.metadata.name}}* rolled back"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {"type": "mrkdwn", "text": "*Namespace:*\n`{{.app.spec.destination.namespace}}`"},
                    {"type": "mrkdwn", "text": "*Revision:*\n`{{.app.status.sync.revision | substr 0 7}}`"}
                  ]
                },
                {
                  "type": "context",
                  "elements": [{"type": "mrkdwn", "text": "<http://argocd.internal.rger.dev/applications/argocd/{{.app.metadata.name}}|View in ArgoCD>"}]
                }
              ]
            }]
      template.app-image-updated: |
        slack:
          attachments: |
            [{
              "color": "#2196f3",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": ":package: *{{.app.metadata.name}}* image updated"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {"type": "mrkdwn", "text": "*Namespace:*\n`{{.app.spec.destination.namespace}}`"},
                    {"type": "mrkdwn", "text": "*Revision:*\n`{{.app.status.sync.revision | substr 0 7}}`"}
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Images:*\n{{range .app.status.summary.images}}`{{.}}`\n{{end}}"
                  }
                },
                {
                  "type": "context",
                  "elements": [{"type": "mrkdwn", "text": "<http://argocd.internal.rger.dev/applications/argocd/{{.app.metadata.name}}|View in ArgoCD>"}]
                }
              ]
            }]
    triggers:
      trigger.on-deployed: |
        - when: app.status.operationState.phase in ['Succeeded'] and app.status.health.status == 'Healthy' and app.status.operationState.operation.sync != nil
          send: [app-deployed]
          oncePer: app.status.sync.revision
      trigger.on-health-degraded: |
        - when: app.status.health.status == 'Degraded' and app.status.operationState.phase != 'Running'
          send: [app-health-degraded]
          oncePer: app.status.health.status
      trigger.on-sync-failed: |
        - when: app.status.operationState.phase in ['Error', 'Failed']
          send: [app-sync-failed]
          oncePer: app.status.operationState.startedAt
      trigger.on-rollback: |
        - when: app.status.operationState.phase == 'Succeeded' and app.status.operationState.operation.rollback != nil
          send: [app-rollback]
          oncePer: app.status.sync.revision
      trigger.on-image-updated: |
        - when: app.status.operationState.phase == 'Succeeded' and app.status.operationState.initiatedBy.automated == true and app.status.operationState.operation.sync != nil
          send: [app-image-updated]
          oncePer: app.status.sync.revision
