apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-alerts
  namespace: {{ .Values.namespace }}
data:
  alerts.yml: |
    groups:
      - name: system-alerts
        rules:
          - alert: InstanceDown
            expr: up == 0
            for: 1m
            labels:
              severity: critical
            annotations:
              summary: "Instance {{ "{{" }}$labels.instance{{ "}}" }} down"
              description: "{{ "{{" }}$labels.instance{{ "}}" }} has been down for more than 1 minute"

          - alert: HighMemoryUsage
            expr: (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes * 100 > 85
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "High memory usage on {{ "{{" }}$labels.instance{{ "}}" }}"
              description: "Memory usage is above 85% for 5 minutes"

          - alert: HighCPUUsage
            expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "High CPU usage on {{ "{{" }}$labels.instance{{ "}}" }}"
              description: "CPU usage is above 80% for 5 minutes"

      - name: storage-alerts
        rules:
          - alert: LokiStorageFull
            expr: loki_ingester_chunk_utilization > 0.9
            for: 5m
            labels:
              severity: critical
            annotations:
              summary: "Loki storage nearly full"
              description: "Loki storage on {{ "{{" }}$labels.instance{{ "}}" }} is approaching capacity"

          - alert: PVCAboveThreshold
            expr: (kubelet_volume_stats_capacity_bytes - kubelet_volume_stats_available_bytes) / kubelet_volume_stats_capacity_bytes > 0.85
            for: 10m
            labels:
              severity: warning
            annotations:
              summary: "PVC usage above 85%"
              description: "PVC {{ "{{" }}$labels.persistentvolumeclaim{{ "}}" }} is above 85% full"

      - name: connectivity-alerts
        rules:
          - alert: TailscaleConnectivityLost
            expr: up{job="alloy"} == 0
            for: 2m
            labels:
              severity: critical
            annotations:
              summary: "Tailscale connectivity lost"
              description: "Alloy on {{ "{{" }}$labels.instance{{ "}}" }} cannot reach monitoring hub via Tailscale"
