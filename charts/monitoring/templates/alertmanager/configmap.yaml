apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-config
  namespace: {{ .Values.namespace }}
data:
  alertmanager.yml: |
    global:
      resolve_timeout: 5m
    route:
      receiver: discord
      group_by: ['alertname', 'severity']
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 4h
      routes:
        - match:
            severity: critical
          receiver: discord-critical
          repeat_interval: 1h
    receivers:
      - name: discord
        discord_configs:
          - webhook_url: ${DISCORD_WEBHOOK}
            title: 'Monitoring Alert'
            message: |
              {{ range .Alerts }}
              **{{ .Annotations.summary }}**
              Severity: {{ .Labels.severity }}
              {{ .Annotations.description }}
              {{ end }}
      - name: discord-critical
        discord_configs:
          - webhook_url: ${DISCORD_CRITICAL_WEBHOOK}
            title: 'CRITICAL: Monitoring Alert'
            message: |
              @everyone {{ range .Alerts }}
              **{{ .Annotations.summary }}**
              Severity: {{ .Labels.severity }}
              {{ .Annotations.description }}
              {{ end }}
